const { argv, env, exit, platform, stdin, stdout, stderr } = require('process');

try {
	require('html-minifier/package');
} catch {
	const { spawnSync } = require('child_process');
	let result = null;
	if (platform == 'win32') {
		result = spawnSync('cmd', ['/C', 'npm', '--prefix=' + env.NODE_PREFIX, 'install', 'html-minifier'], {'stdio': ['ignore', 'ignore', 'inherit']});
	} else {
		result = spawnSync('npm', ['--prefix=' + env.NODE_PREFIX, 'install', 'html-minifier'], {'stdio': ['ignore', 'ignore', 'inherit']});
	}
	if (result.status != 0) {
		stderr.write("npm failed to run, is it installed?\n");
		exit(result.status);
	}
	result = spawnSync('node', argv.slice(1), {'stdio': 'inherit'});
	exit(result.status);
}

const html_minifier = require('html-minifier');

const options = {
	includeAutoGeneratedTags: true,
	removeAttributeQuotes: true,
	removeComments: true,
	removeRedundantAttributes: true,
	removeScriptTypeAttributes: true,
	removeStyleLinkTypeAttributes: true,
	sortClassName: true,
	useShortDoctype: true,
	collapseWhitespace: true
};

var input = '';
stdin.setEncoding('utf-8');
stdin.on('data', (data) => {
	input = input.concat(data.toString());
});
stdin.on('close', () => {
	let output = html_minifier.minify(input, options);
	stdout.write(output);
	exit(0);
});
